<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WorkZap â€” Chat (Hirer â†” Applicant)</title>
  
<style>
  :root{
    --bg:#f4f8ff;
    --card:#ffffff;
    --muted:#000000;
    --hirer:#403d98;
    --applicant:#0ea5e9;
    --incoming:#eef6ff;
    --outgoing:#f4ecff;
    --glass: rgba(255,255,255,0.6);
    --radius:12px;
    --shadow: 0 6px 20px rgba(22, 28, 49, 0.08);
    --max-width:980px;
    --gap:14px;
    --font: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  html,body{height:100%;margin:0;font-family:var(--font);background:
    radial-gradient(800px 300px at 10% 10%, rgba(14,165,233,0.06), transparent),
    linear-gradient(180deg,var(--bg),#f8fbff);
    color:#111827; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
  }

  .chat-shell{
    max-width:var(--max-width);
    margin:36px auto;
    display:grid;
    grid-template-columns: 320px 1fr;
    gap:24px;
    padding:20px;
  }

  /* Sidebar (conversations) */
  .sidebar{
    background:linear-gradient(180deg,var(--card),var(--glass));
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:16px;
    display:flex;
    flex-direction:column;
    gap:12px;
    min-height:560px;
  }
  .brand{
    display:flex;align-items:center;gap:10px;
  }
  .logo{
    width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--hirer),var(--applicant));
    display:grid;place-items:center;color:white;font-weight:700;font-size:18px;
    box-shadow:0 6px 16px rgba(64,61,152,0.12);
  }
  .sb-search{
    display:flex;align-items:center;gap:8px;margin-top:8px;
    background:#f7f9ff;padding:8px;border-radius:10px;
  }
  .sb-search input{flex:1;border:none;background:transparent;outline:none;color:#0f1724;font-size:14px;}
  .convo-list{overflow:auto;padding-right:6px;}
  .convo{
    display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;cursor:pointer;
  }
  .convo:hover{background:#f1f6ff;}
  .convo .av{width:44px;height:44px;border-radius:10px;display:grid;place-items:center;color:white;font-weight:700;}
  .convo .meta{flex:1}
  .convo .meta .title{font-weight:600}
  .convo .meta .sub{color:var(--muted);font-size:13px;margin-top:4px}
  .convo .badge{background:#fde68a;color:#92400e;padding:6px 8px;border-radius:999px;font-weight:600;font-size:12px}

  /* Main chat card */
  .chat-card{
    background:linear-gradient(180deg,var(--card),#ffffff);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    display:flex;
    flex-direction:column;
    min-height:560px;
    overflow:hidden;
  }

  .chat-header{
    padding:18px 20px;border-bottom:1px solid #f0f3ff;display:flex;align-items:center;gap:12px;
  }
  .chat-header .title{font-weight:700;font-size:16px}
  .chat-header .role{color:var(--muted);font-size:13px}
  .chat-actions{margin-left:auto;display:flex;gap:10px;align-items:center}
  .icon-btn{background:none;border:none;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted);font-size:16px}
  .icon-btn:hover{background:#fbfbff;color:var(--hirer)}

  .messages{
    padding:20px;flex:1;display:flex;flex-direction:column;gap:12px;overflow:auto;background:
    linear-gradient(180deg, rgba(14,165,233,0.02), transparent 40%);
  }

  /* message bubbles */
  .msg-row{display:flex;gap:12px;align-items:flex-end}
  .msg-row.incoming{justify-content:flex-start}
  .msg-row.outgoing{justify-content:flex-end}
  .bubble{
    max-width:66%;
    padding:12px 14px;border-radius:12px;font-size:14px;line-height:1.35;
    box-shadow:0 4px 10px rgba(21,24,54,0.04);
  }
  .bubble .meta{display:flex;gap:8px;align-items:center;margin-top:8px;font-size:12px;color:var(--muted)}
  .bubble.incoming{background:var(--incoming);border-top-left-radius:6px}
  .bubble.outgoing{background:var(--outgoing);border-top-right-radius:6px;color:#24144d}

  .avatar-small{width:36px;height:36px;border-radius:9px;display:grid;place-items:center;color:white;font-weight:700}

  /* typing indicator */
  .typing{
    display:flex;align-items:center;gap:10px;background:transparent;padding:6px 10px;border-radius:999px;color:var(--muted);
  }
  .dots{display:flex;gap:4px;align-items:flex-end}
  .dot{width:7px;height:7px;border-radius:999px;background:#cbd5e1;animation:blink 1s infinite}
  .dot:nth-child(2){animation-delay:0.12s}
  .dot:nth-child(3){animation-delay:0.24s}
  @keyframes blink{0%{transform:translateY(0);opacity:0.4}50%{transform:translateY(-6px);opacity:1}100%{transform:translateY(0);opacity:0.4}}

  /* composer */
  .composer{padding:14px;border-top:1px solid #f0f3ff;display:flex;gap:10px;align-items:center}
  .composer textarea{flex:1;resize:none;height:46px;padding:10px 12px;border-radius:10px;border:1px solid #eef3ff;background:white;outline:none;font-size:14px}
  .composer .send-btn{background:linear-gradient(90deg,var(--hirer),var(--applicant));color:white;padding:10px 14px;border-radius:9px;border:none;cursor:pointer;font-weight:600}
  .composer .tools{display:flex;gap:8px;align-items:center}
  .small{font-size:13px;color:var(--muted)}

  /* responsive */
  @media (max-width:900px){
    .chat-shell{grid-template-columns:1fr; padding:12px}
    .sidebar{order:2}
    .chat-card{order:1}
  }
</style>
<style>
  .msg-row { display:flex; gap:8px; margin-bottom:10px; align-items:flex-end; }
  .msg-row.incoming { justify-content:flex-start; }
  .msg-row.outgoing { justify-content:flex-end; }
  .bubble.incoming { background:#a2b1df; color:#000103; }
  .bubble.outgoing { background:#da90c4; color:#f9f9f9; }
</style>

</head>
<body>
 <%- include('partials/header') %>
<div class="chat-shell" role="application" aria-label="Hirer applicant chat">
  <aside class="sidebar" aria-label="Conversations">
    <div class="brand">
      <div class="logo">WZ</div>
      <div>
        <div style="font-weight:700">WorkZap</div>
        <div style="font-size:13px;color:var(--muted)">Applicants â€” Conversations</div>
      </div>
    </div>

    <div class="sb-search" role="search" aria-label="Search conversations">
      <svg width="16" height="16" fill="none" viewBox="0 0 24 24" aria-hidden>
        <path d="M21 21l-4.35-4.35" stroke="#94a3b8" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      <input placeholder="Search name or email" id="convSearch" />
    </div>

    <!--  -->
    <form id="convoForm" method="post" action="/chat" style="display:none">
  <input type="hidden" name="index" id="convoIndex">
  <input type="hidden" name="email" id="convoEmail">
</form>

<header id="header" style="display:flex;gap:12px;align-items:center;padding:12px">
  <div id="headerAvatar" style="width:40px;height:40px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#3b82f6;color:#fff">U</div>
  <div>
    <div id="headerTitle">Conversation</div>
    <div id="headerSub" style="font-size:12px;color:#666">Select a conversation</div>
  </div>
</header>

<div class="convo-list" id="convoList" aria-live="polite">
  <% (chattedAccount || []).forEach(function(email, idx){ %>
    <div class="convo" data-id="<%= idx %>" data-email="<%= email %>" onclick="selectConvo(this)" style="display:flex;gap:12px;padding:8px;cursor:pointer;border-radius:6px;">
      <div class="av" style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;color:#fff;background:linear-gradient(135deg,var(--applicant),#22c1c3)">
        <%= (email && email[0] || 'U').toUpperCase() %>
      </div>
      <div class="meta">
        <div class="title"><%= email %></div>
        <div class="sub">Click to Refresh Chat</div>
      </div>
    </div>
  <% }) %>
</div>


  </aside>

  <section class="chat-card" aria-label="Conversation panel">
    <header class="chat-header">
      <div style="display:flex;gap:12px;align-items:center">
        <div class="avatar-small" id="headerAvatar" style="background:linear-gradient(135deg,var(--applicant),#22c1c3)">U</div>
        <div>
          
            <div class="title" id="headerTitle">Select a conversation :</div>
          
          <div class="role" id="headerSub">&nbsp;</div>
        </div>
      </div>
      <div class="chat-actions">
        <button class="icon-btn" title="Call" type="button">ðŸ“ž</button>
        <button class="icon-btn" title="View profile" type="button">ðŸ‘¤</button>
        <button class="icon-btn" title="More" type="button">â‹¯</button>
      </div>
    </header>

    <div id="messages">
  <% 
    const loggedEmail = (typeof email !== 'undefined') ? email : (locals && locals.email ? locals.email : '');
    const msgs = Array.isArray(chatObject) ? chatObject : [];
    msgs.forEach(obj => {
      const isOutgoing = obj.email === loggedEmail;
  %>
    <div class="msg-row <%= isOutgoing ? 'outgoing' : 'incoming' %>">
      <% if (!isOutgoing) { %>
        <div class="avatar-small" style="background: linear-gradient(135deg,var(--applicant),#22c1c3);">
          <%= (obj.email && obj.email[0]) ? obj.email[0].toUpperCase() : 'U' %>
        </div>
      <% } %>

      <div class="bubble <%= isOutgoing ? 'outgoing' : 'incoming' %>">
        <%= obj.message %>
        <div class="meta"><span class="small"><%= obj.timestamp ? new Date(obj.timestamp).toLocaleTimeString() : 'Earlier' %></span></div>
      </div>

      <% if (isOutgoing) { %>
        <div style="width:36px;flex:0 0 36px"></div>
      <% } %>
    </div>
  <% }) %>
</div>



    <form class="composer" id="composer" action="/sendMessage" method="POST" onsubmit="return sendMessage()">
      <div class="tools" aria-hidden>
        <button type="button" class="icon-btn" title="Attach file" onclick="attachFile()">ðŸ“Ž</button>
        <button type="button" class="icon-btn" title="Emoji" onclick="insertEmoji()">ðŸ˜Š</button>
      </div>
      <input type="hidden" name="recipientEmail" id="recipientEmailField" value="<%= selectedAccount || '' %>" />
      <textarea id="msgInput" name="message" placeholder="Write a message..." aria-label="Message input"></textarea>
      <button type="submit" class="send-btn">Send</button>
    </form>
  </section>
</div>


<script>
  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('msgInput');
  const recipientEmailField = document.getElementById('recipientEmailField');
  const selectedEmail2 = recipientEmailField?.value || '';
  let selectedEmail = '';

  function scrollToBottom(){
    if (!messagesEl) return;
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function sendMessage(){
    const text = input.value.trim();
    // const emailToUse = selectedEmail2 || (recipientEmailField && recipientEmailField.value) || '';
    if (!text || !selectedEmail2) return false;

    if (recipientEmailField) recipientEmailField.value = selectedEmail2;

    const row = document.createElement('div');
    row.className = 'msg-row outgoing';
    const bubble = document.createElement('div');
    bubble.className = 'bubble outgoing';
    bubble.setAttribute('role','article');
    bubble.innerHTML = text + '<div class="meta"><span class="small">Now</span></div>';
    row.appendChild(bubble);
    if (messagesEl) messagesEl.appendChild(row);

    input.value = text;
    scrollToBottom();
    simulateReply();
    return true;
  }

  function simulateReply(){
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) typingIndicator.style.display = 'flex';
    setTimeout(()=>{
      if (typingIndicator) typingIndicator.style.display = 'none';

      const row = document.createElement('div');
      row.className = 'msg-row incoming';
      const av = document.createElement('div');
      av.className = 'avatar-small';
      av.style.background = 'linear-gradient(135deg,var(--applicant),#22c1c3)';
      av.textContent = 'RS';
      const bubble = document.createElement('div');
      bubble.className = 'bubble incoming';
      bubble.innerHTML = 'Thanks â€” noted. Iâ€™ll join at 3 PM.' + '<div class="meta"><span class="small">Now</span></div>';
      row.appendChild(av);
      row.appendChild(bubble);
      if (messagesEl) messagesEl.appendChild(row);
      scrollToBottom();
    }, 1200);
  }

  function selectConvo(el){
    if (!el) return;

    document.querySelectorAll('.convo').forEach(c => c.style.background = '');
    el.style.background = '#eef6ff';

    const name = el.querySelector('.title')?.textContent || 'Conversation';
    const sub = el.querySelector('.sub')?.textContent || '';
    selectedEmail = el.getAttribute('data-email') || '';

    const headerTitle = document.getElementById('headerTitle');
    const headerSub = document.getElementById('headerSub');
    if (headerTitle) headerTitle.textContent = name;
    if (headerSub) headerSub.textContent = sub;

    const av = document.getElementById('headerAvatar');
    if (av) av.textContent = name[0]?.toUpperCase() || 'U';

    // submit hidden form to /chat with index so page refreshes and server receives the index
    const idx = el.getAttribute('data-id');
    const convoForm = document.getElementById('convoForm');
    const formIndex = document.getElementById('convoIndex');
    const formEmail = document.getElementById('convoEmail');

    if (convoForm && formIndex && formEmail) {
      formIndex.value = idx;
      formEmail.value = selectedEmail;
      convoForm.submit();
    } else {
      // fallback: redirect with query params
      location.href = `/chat?index=${encodeURIComponent(idx)}&email=${encodeURIComponent(selectedEmail)}`;
    }
  }

  function attachFile(){ alert('Attach file dialog (implement as needed)'); }
  function insertEmoji(){ input.value += ' ðŸ˜Š'; input.focus(); }

  input.addEventListener('keydown', e=>{
    if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      const composer = document.getElementById('composer');
      if (composer) composer.submit();
    }
  });

  // initial scroll
  scrollToBottom();

  // expose for inline onclicks
  window.selectConvo = selectConvo;
  window.sendMessage = sendMessage;
</script>



<!-- <script>
  const messagesEl = document.getElementById('messages');
  const input = document.getElementById('msgInput');
  const recipientEmailField = document.getElementById('recipientEmailField');
  let selectedEmail = '';

  function scrollToBottom(){
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function sendMessage(){
    const text = input.value.trim();
    if(!text || !selectedEmail) return false;

    recipientEmailField.value = selectedEmail;
    // input.value =text;
    const row = document.createElement('div');
    row.className = 'msg-row outgoing';
    const bubble = document.createElement('div');
    bubble.className = 'bubble outgoing';
    bubble.setAttribute('role','article');
    bubble.innerHTML = text + '<div class="meta"><span class="small">Now</span></div>';
    row.appendChild(bubble);
    messagesEl.appendChild(row);
    input.value=text;
    scrollToBottom();
    simulateReply();
    return true;
  }

  function simulateReply(){
    const typingIndicator = document.getElementById('typingIndicator');
    if (typingIndicator) typingIndicator.style.display = 'flex';
    setTimeout(()=>{
      if (typingIndicator) typingIndicator.style.display = 'none';
      const row = document.createElement('div');
      row.className = 'msg-row incoming';
      const av = document.createElement('div');
      av.className = 'avatar-small';
      av.style.background = 'linear-gradient(135deg,var(--applicant),#22c1c3)';
      av.textContent = 'RS';
      const bubble = document.createElement('div');
      bubble.className = 'bubble incoming';
      bubble.innerHTML = 'Thanks â€” noted. Iâ€™ll join at 3 PM.' + '<div class="meta"><span class="small">Now</span></div>';
      row.appendChild(av);
      row.appendChild(bubble);
      messagesEl.appendChild(row);
      scrollToBottom();
    }, 1200);
  }

  function selectConvo(el){
    document.querySelectorAll('.convo').forEach(c => c.style.background='transparent');
    el.style.background = '#eef6ff';
    const name = el.querySelector('.title')?.textContent || 'Conversation';
    const sub = el.querySelector('.sub')?.textContent || '';
    selectedEmail = el.getAttribute('data-email') || '';
    document.getElementById('headerTitle').textContent = name;
    document.getElementById('headerSub').textContent = sub;
    const av = document.getElementById('headerAvatar');
    if (av) av.textContent = name[0]?.toUpperCase() || 'U';
  }

  function attachFile(){ alert('Attach file dialog (implement as needed)'); }
  function insertEmoji(){ input.value += ' ðŸ˜Š'; input.focus(); }

  input.addEventListener('keydown', e=>{
    if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){
      e.preventDefault();
      document.getElementById('composer').submit();
    }
  });

  scrollToBottom();
</script> -->

</body>
</html>
